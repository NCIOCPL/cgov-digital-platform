!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.CKEditor5=t():(e.CKEditor5=e.CKEditor5||{},e.CKEditor5.glossifier=t())}(self,()=>(()=>{var e={"ckeditor5/src/core.js":(e,t,s)=>{e.exports=s("dll-reference CKEditor5.dll")("./src/core.js")},"ckeditor5/src/ui.js":(e,t,s)=>{e.exports=s("dll-reference CKEditor5.dll")("./src/ui.js")},"dll-reference CKEditor5.dll":e=>{"use strict";e.exports=CKEditor5.dll}},t={};function s(n){var i=t[n];if(void 0!==i)return i.exports;var o=t[n]={exports:{}};return e[n](o,o.exports,s),o.exports}s.d=(e,t)=>{for(var n in t)s.o(t,n)&&!s.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var n={};return(()=>{"use strict";s.d(n,{default:()=>y});var e=s("ckeditor5/src/core.js"),t=s("ckeditor5/src/ui.js");class i extends e.Plugin{init(){const{editor:e}=this;e.ui.componentFactory.add("glossifier",s=>{const n=new t.ButtonView(s);return n.set({label:e.t("Glossify Page"),icon:'<?xml version="1.0" encoding="UTF-8"?>\n<svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">\n  <defs>\n    <style>\n      .cls-1 {\n        fill: #333;\n      }\n    </style>\n  </defs>\n  <g id="Dictionary">\n    <polygon class="cls-1" points="5.1 4.47 4.5 5.83 5.69 5.83 5.1 4.47"/>\n    <rect class="cls-1" x="5.4" y="10" width="6.74" height="1.84"/>\n    <path class="cls-1" d="M17.05,2.03h-.31v-.92c0-.34-.28-.61-.61-.61H3.26C1.91.5.81,1.6.81,2.95v13.48c0,1.14.78,2.1,1.84,2.38v-1.31c-.37-.21-.61-.61-.61-1.06,0-.68.55-1.23,1.23-1.23h10.75c-.21.36-.33.78-.33,1.23s.12.86.33,1.23H4.48v-1.23c0-.34-.27-.61-.61-.61s-.61.27-.61.61v2.45c0,.34.27.61.61.61s.61-.27.61-.61h11.25s.09,0,.13-.02c.09,0,.18.02.27.02.34,0,.61-.28.61-.61v-6.13h1.23c.68,0,1.23-.55,1.23-1.23v-6.74c0-1.18-.96-2.15-2.15-2.15ZM17.05,3.26c.51,0,.92.41.92.92v2.05c-.28-.13-.59-.21-.92-.21h-.31v-2.76h.31ZM8.16,4.79h1.23c.34,0,.61.28.61.61s-.28.61-.61.61h-1.23c-.34,0-.61-.28-.61-.61s.28-.61.61-.61ZM3.34,7.82c-.32-.12-.47-.48-.35-.79l1.53-3.98c.09-.24.32-.39.57-.39s.48.16.57.39l1.53,3.98c.12.32-.04.67-.35.79-.07.03-.15.04-.22.04-.25,0-.48-.15-.57-.39l-.2-.53h-1.51l-.2.53c-.12.32-.48.47-.79.35ZM13.37,12.15c0,.51-.41.92-.92.92h-7.35c-.51,0-.92-.41-.92-.92v-2.45c0-.51.41-.92.92-.92h7.35c.51,0,.92.41.92.92v2.45ZM13.98,7.55h-3.06c-.24,0-.45-.14-.55-.35s-.07-.47.08-.65l2.23-2.67h-1.76c-.34,0-.61-.28-.61-.61s.28-.61.61-.61h3.06c.24,0,.45.14.55.35s.07.47-.08.65l-2.23,2.67h1.76c.34,0,.61.28.61.61s-.28.61-.61.61ZM16.74,10.92v-3.68h.31c.51,0,.92.41.92.92v2.76s-1.23,0-1.23,0Z"/>\n  </g>\n</svg>',tooltip:!0}),this.listenTo(n,"execute",()=>e.execute("glossifyAction")),n})}}const o=(e,t)=>{if(!e||"string"!=typeof e)return t;if(0===e.length)return t;const s=decodeURIComponent(e),n=(new window.DOMParser).parseFromString(s,"text/html");let i;return i=0===n.body.children.length?t:n.body,i},a=e=>{const t=e.textContent,s=e.dataset.preexisting;let n=o(e.dataset.html,t),i="";i="string"==typeof n?n:n.innerHTML;let a=t;"true"===s&&(a=i);const r=document.createElement("nci-definition");r.dataset.glossId=e.dataset.glossId,r.dataset.glossDictionary=e.dataset.glossDictionary,r.dataset.glossAudience=e.dataset.glossAudience,r.dataset.glossLang=e.dataset.glossLang,r.innerHTML=a,e.replaceWith(r)},r=(e,t,s,n,i,a,r,l)=>{const d="glossify-dialog__term "+(r?"glossify-dialog__term--first":"");let c=e;if("true"===l&&a&&""!==a){let e=o(label.dataset.html,originalText);c="string"==typeof e?e:e.innerHTML}return`<label\n       data-gloss-id="${t}"\n       data-gloss-dictionary="${s}"\n       data-gloss-audience="${n}"\n       data-gloss-lang="${i}"\n       class="${d}"\n       data-preexisting="${l}"\n       data-html="${a}"\n       data-glossify-label\n    >${c}<input type="checkbox"/></label>`},l=(e,t)=>{const s=((e,t)=>{let s="",n=0;const i=(new window.DOMParser).parseFromString(e,"text/html").querySelectorAll("span[rel='glossified']");for(let o=0;o<t.length;o++){const a=t[o],l=a.start,d=l+a.length;s+=e.slice(n,l),n=l;const c=e.slice(n,d);n=d;const g=a.doc_id?parseInt(a.doc_id?.slice(3)):NaN,u=a.dictionary,h=a.audience,m=a.language;let p="";for(let e=0;e<i.length;e++)i[e].dataset.term===c&&(p=i[e].dataset.html);const f=a.first_occurrence;s+=r(c,g,u,h,m,p,f,!1)}return s+=e.slice(n),s})(e,t),n=document.createElement("div");n.insertAdjacentHTML("afterbegin",s);return n.querySelectorAll("span[rel='glossified']").forEach(function(e){const t=e.dataset.term,s=e.dataset.html,n=e.dataset.glossId,i=e.dataset.glossDictionary,o=e.dataset.glossAudience,a=e.dataset.glossLang,l=r(t,n,i,o,a,s,!1,!0);e.innerHTML=l;const d=e.querySelector("label");d.querySelector("input").checked=!0,e.replaceWith(d)}),n},d=e=>{const t=e.querySelectorAll("label[data-glossify-label]");for(const e of t){if(e.querySelector("input").checked)a(e);else{const t=e.dataset.preexisting,s=e.textContent;let n=o(e.dataset.html,s);"true"===t&&(n instanceof HTMLElement||n instanceof NodeList)&&n.childNodes.length>0?e.replaceWith(...n.childNodes):e.replaceWith(s)}}return e.innerHTML},c=e=>{switch(e){case"\n":return"&#x000a;";case"”":return"&#148;";case"—":return"&#151;";case"–":return"&#150;";case"Á":return"&#193;";case"Í":return"&#205;";default:return e}},g=e=>{const t=(e=>{const t=(new window.DOMParser).parseFromString(e,"text/html"),s=t.body.querySelectorAll("nci-definition");for(const e of s){const t=document.createElement("span");t.setAttribute("rel","glossified"),t.dataset.preexisting="true",t.dataset.glossLang=e.dataset.glossLang,t.dataset.glossId=e.dataset.glossId,t.dataset.glossDictionary=e.dataset.glossDictionary,t.dataset.glossAudience=e.dataset.glossAudience;const s=["strong","em","span","sup","sub"];Array.from(e.getElementsByTagName("*")).forEach(e=>{if(!s.includes(e.tagName.toLowerCase())){const t=e.textContent;e.replaceWith(t)}});const n=encodeURIComponent(e.innerHTML),i=e.textContent;t.dataset.html=n!==i?n:"",t.dataset.term=i,e.replaceWith(t)}return t.body.innerHTML})(e);let s="";for(let e=0;e<t.length;e++)s+=c(t.charAt(e));return s},u=async(e,t)=>{let s=null;try{const e=await fetch(Drupal.url("session/token"));if(200!==e.status)throw new Error(`CSRF request responded with status ${e.status}`);s=await e.text()}catch(e){throw console.error(e),new CsrfException(e.message)}try{const n=await fetch(Drupal.url("pdq/api/glossifier"),{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-Token":s},body:JSON.stringify({fragment:e,languages:[t],dictionaries:["Cancer.gov"]})});if(200!==n.status)throw new Error(`Glossification request responded with status ${n.status}`);return(await n.json()).map(e=>({...e,audience:"Patient"}))}catch(e){throw console.error(e),new GlossifierApiException(e.message)}},h=async e=>{const t=g(e),s=(()=>{const e=window.drupalSettings.path,t=e.currentPath;let s;s=/^node\/add\/.+/i.test(t)?document.getElementById("edit-langcode-0-value").value:e.currentLanguage;return s})(),n=await u(t,s);return l(t,n)};class m extends Error{}class p extends e.Command{constructor(e){super(e);const t=document.createElement("div");t.classList.add("cke_dialog_body");const s=document.createElement("div");s.classList.add("glossify-dialog-container"),t.appendChild(s),this.modalContents=document.createElement("div"),this.buttonContents=document.createElement("div"),this.buttonContents.classList.add("glossify-dialog-buttons"),s.appendChild(this.modalContents),s.appendChild(this.buttonContents),this.modalInstance=Drupal.dialog(t,{modal:!0,dialogClass:"cgov_reset_all",title:Drupal.t("Glossify Page"),closeOnEscape:!0,width:"75%"})}_repositionModal(){window.dispatchEvent(new Event("resize"))}_setModalContentsToSpinner(){this.modalContents.replaceChildren(),this.buttonContents.replaceChildren(),this.modalContents.insertAdjacentHTML("afterbegin",'<div class="glossify-dialog__spinner-outer"><div class="glossify-dialog__spinner-inner"></div></div>'),this._repositionModal()}_setModalContentsToError(e){this.modalContents.replaceChildren(),this.buttonContents.replaceChildren(),this.modalContents.insertAdjacentHTML("afterbegin",`<p class="glossify-dialog__error">${e}</p>`),this._repositionModal()}_setModalContentsToSuggestions(e){this.modalContents.replaceChildren(),this.modalContents.replaceChildren(...e.childNodes),this.buttonContents.replaceChildren();const t=document.createElement("button");t.classList.add("button","button--primary"),t.addEventListener("click",this._updateEditorWithSelections.bind(this)),t.innerText=Drupal.t("Save");const s=document.createElement("button");s.classList.add("button"),s.innerText=Drupal.t("Cancel"),s.addEventListener("click",()=>{this.modalInstance.close()}),this.buttonContents.appendChild(t),this.buttonContents.appendChild(s),this._repositionModal()}_updateEditorWithSelections(){const e=d(this.modalContents);this.editor.data.set(e),this.modalInstance.close()}execute(){const e=this.editor;this._setModalContentsToSpinner(),h(e.data.get()).then(e=>{this._setModalContentsToSuggestions(e)}).catch(e=>{e instanceof m?this._setModalContentsToError(`Unable to retrieve session token: ${e.message}`):this._setModalContentsToError(`Glossifier request failed: ${e.message}`)}),this.modalInstance.showModal()}}class f extends e.Plugin{init(){const e=this.editor.config.get("nci_definition"),t=this.editor.model.schema,s=this.editor.conversion;this._defineSchema(t),this._defineUpcastConverter(s),this._defineLegacyUpcastConverter(s),this._defineEditingDowncast(s,e),this._defineDataDowncast(s),this._preventLinksInDefinitions(s),this.editor.data.htmlProcessor.domConverter.inlineObjectElements.push("nci-definition"),this.editor.editing.view.domConverter.inlineObjectElements.push("nci-definition"),this.editor.commands.add("glossifyAction",new p(this.editor)),this._disableLinkCommandInDefinitions()}_defineSchema(e){e.register("nciDefinition",{allowWhere:"$text",allowContentOf:"$block",isInline:!0,isObject:!0,disallowChildren:["drupalEntity","htmlObject","htmlIframe","htmlVar","htmlInput","htmlButton","htmlTextarea","htmlSelect","htmlEmbed","htmlOembed","htmlCanvas","htmlMeter","htmlProgress","htmlImg","nciDefinition","htmlAudio","htmlVideo"],allowAttributes:["glossId","glossDictionary","glossAudience","glossLang"]}),e.addChildCheck((e,t)=>{if(e.endsWith("nciDefinition")&&"a"===t.name)return!1})}_defineUpcastConverter(e){e.for("upcast").elementToElement({view:{name:"nci-definition",attributes:["data-gloss-id","data-gloss-dictionary","data-gloss-audience","data-gloss-lang"]},model:(e,{writer:t})=>t.createElement("nciDefinition",{glossId:e.getAttribute("data-gloss-id"),glossDictionary:e.getAttribute("data-gloss-dictionary"),glossAudience:e.getAttribute("data-gloss-audience"),glossLang:e.getAttribute("data-gloss-lang")})})}_defineEditingDowncast(e,t){e.for("editingDowncast").elementToElement({model:"nciDefinition",view:(e,{writer:s})=>{const n=e.getAttribute("glossId"),i=e.getAttribute("glossDictionary"),o=e.getAttribute("glossAudience"),a=e.getAttribute("glossLang"),r=t.nci_glossary_dictionary_urls?.find(e=>e.dictionary?.toLowerCase()===i?.toLowerCase()&&e.audience?.toLowerCase()===o?.toLowerCase()&&e.langcode?.toLowerCase()===a?.toLowerCase())?.formatter,l=r?r.replace("%s",n):"#UNKNOWN_FORMATTER";return s.createContainerElement("a",{...t.definition_classes?{class:t.definition_classes}:{},href:l,"data-gloss-id":n,"data-gloss-dictionary":i,"data-gloss-audience":o,"data-gloss-lang":a})}})}_defineDataDowncast(e){e.for("dataDowncast").elementToElement({model:"nciDefinition",view:(e,{writer:t})=>t.createContainerElement("nci-definition",{"data-gloss-id":e.getAttribute("glossId"),"data-gloss-dictionary":e.getAttribute("glossDictionary"),"data-gloss-audience":e.getAttribute("glossAudience"),"data-gloss-lang":e.getAttribute("glossLang")})})}_defineLegacyUpcastConverter(e){e.for("upcast").add(e=>{e.on("element:a",(e,t,s)=>{const n=t.viewItem;if(!n.hasClass("definition"))return;const i=n.getAttribute("href");if(!/^(http[s]*:\/\/[^\/]*|)\/Common\/PopUps\/popDefinition\.aspx\?id=([^&]*)&version=(patient|healthprofessional)&language=(English|Spanish|en|es)$/i.test(i)&&!/^\/Common\/PopUps\/popDefinition\.aspx\?id=([^&]*)&version=(patient|healthprofessional)&language=(English|Spanish|en|es)&dictionary=([^&]*)$/i.test(i))return;const o=new URL(i,"https://example.org"),a=(e=>{if(e.hasAttribute("data-glossary-id")){const t=parseInt(e.getAttribute("data-glossary-id").replace(/^CDR0*/,""));return isNaN(t)?null:t}const t=e.getAttribute("href"),s=new URL(t,"https://example.org"),n=parseInt(s.searchParams.get("id")?.replace(/\D+/,""));return isNaN(n)?null:n})(n);if(!a)return void console.warn("Glossifier: Unable to extract glossary ID from link.");const r="healthprofessional"===o.searchParams.get("version")?.toLowerCase()?"HealthProfessional":"Patient",l=o.searchParams.get("language")?.toLowerCase(),d="spanish"===l||"es"===l?"es":"en",{writer:c,consumable:g,safeInsert:u,convertChildren:h}=s;if(!g.consume(n,{name:!0}))return;for(const e of n.getAttributeKeys())g.consume(n,{attributes:e});const m=c.createElement("nciDefinition",{glossId:a,glossDictionary:"Cancer.gov",glossAudience:r,glossLang:d});h(n,m),u(m,t.modelCursor)&&s.updateConversionResult(m,t)},{priority:"high"})})}_disableLinkCommandInDefinitions(){const e=this.editor,t=e.commands.get("link");if(t){const s=t.refresh.bind(t);t.refresh=()=>{s();const n=e.model.document.selection,i=n.getSelectedElement();if(i&&i.is("element","nciDefinition"))return void(t.isEnabled=!1);const o=n.getFirstPosition();if(o){o.getAncestors().some(e=>e.is("element","nciDefinition"))&&(t.isEnabled=!1)}},t.refresh()}}_preventLinksInDefinitions(e){e.for("upcast").add(e=>{e.on("element:a",(e,t,s)=>{const n=t.viewItem;let i=n.parent;for(;i;){if(i.is("element","nci-definition")){const{consumable:i,convertChildren:o}=s;return void(i.consume(n,{name:!0})&&(o(n,t.modelCursor),e.stop()))}i=i.parent}},{priority:"high"})})}}class C extends e.Plugin{static get requires(){return[f,i]}}const y={Glossify:C}})(),n=n.default})());