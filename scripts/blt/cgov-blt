#!/usr/bin/env php
<?php

/**
 * @file
 * Custom BLT bootstrap for CGOV that handles MEO environment detection.
 */

// Get repository root.
$repo_root = dirname(__DIR__, 2);

// Find the autoloader.
$candidates = [
  $repo_root . '/vendor/autoload.php',
  dirname($repo_root) . '/vendor/autoload.php',
  dirname($repo_root, 2) . '/vendor/autoload.php',
];

$classLoader = null;
foreach ($candidates as $candidate) {
  if (file_exists($candidate)) {
    $classLoader = require_once $candidate;
    break;
  }
}

use Cgov\Blt\Plugin\Config\CustomConfigInitializer;
use Acquia\Blt\Robo\Blt;
use Symfony\Component\Console\Input\ArgvInput;
use Symfony\Component\Console\Output\ConsoleOutput;

// Initialize input/output.
$input = new ArgvInput();
$output = new ConsoleOutput();

// Write BLT version for debugging.
if ($output->isVerbose()) {
  $output->writeln("<comment>BLT version " . Blt::getVersion() . "</comment>");
  $output->writeln("<comment>Using CGOV ConfigInitializer for MEO environment handling</comment>");
}

// Initialize configuration with our custom initializer.
$config_initializer = new CustomConfigInitializer($repo_root, $input);
$config = $config_initializer->initialize();

// Execute command.
$blt = new Blt($config, $input, $output, $classLoader);
$status_code = (int) $blt->run($input, $output);

if (!$input->getFirstArgument() || $input->getFirstArgument() == 'list') {
  $output->writeln("<comment>To create custom BLT commands, see https://docs.acquia.com/blt/extending-blt/#adding-a-custom-robo-hook-or-command.</comment>");
  $output->writeln("<comment>To add BLT commands via community plugins, see https://support.acquia.com/hc/en-us/articles/360046918614-Acquia-BLT-Plugins</comment>");
}

exit($status_code);